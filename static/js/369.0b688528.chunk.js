"use strict";(self.webpackChunkboxxerworld_customiser=self.webpackChunkboxxerworld_customiser||[]).push([[369],{9369:(e,t,a)=>{a.r(t),a.d(t,{default:()=>j});var n=a(4875),o=a(9389),i=a(2791),l=a(7760),r=a(9355),d=a(846),s=a(9740),u=a(184);const c=e=>{let{node:t,texture:a,tasselsTexture:o,tassels:r,hex:s}=e;const[c,v]=(0,i.useState)(),p=(0,i.useRef)(null),m=(0,i.useRef)(null),[f,b]=(0,i.useState)(!1),[g,x]=(0,i.useState)(!1),h=(0,i.useMemo)((()=>Object.fromEntries(Object.entries(a).map((e=>{let[t,a]=e;return[t,a.clone()]})))),[a]),{customProduct:M,setSelectedNav:y,selectedNav:j,savedParts:w,navTabs:P,texts:S,flags:T,graphics:R,updateText:k,updateIsMinimizedCustomiserNav:U}=(0,n.b)(),O=(0,i.useMemo)((()=>S.find((e=>e.edit))),[S]),D=(0,i.useMemo)((()=>T.find((e=>e.edit))),[T]),N=(0,i.useMemo)((()=>R.find((e=>e.edit))),[R]),C=(0,i.useMemo)((()=>{var e,a;return null===M||void 0===M||null===(e=M.attributes)||void 0===e||null===(a=e.parts)||void 0===a?void 0:a.find((e=>{var a;return null===e||void 0===e||null===(a=e.modelParts)||void 0===a?void 0:a.data.find((e=>{var a,n;return(null===(a=e.attributes)||void 0===a?void 0:a.nodeId)===t.userData.name||(null===(n=e.attributes)||void 0===n?void 0:n.nodeId)===t.name}))}))}),[M,t]),I="Crystals"===(null===C||void 0===C?void 0:C.name)?s:void 0,E=(0,i.useMemo)((()=>{if(null!==C&&void 0!==C&&C.id)return(0,d.TR)({navTabs:P,value:C.id,key:"id"})}),[C,P]),V=(0,i.useMemo)((()=>{if(null!==C&&void 0!==C&&C.id)return(0,d.TR)({navTabs:P,value:"names",key:"type"})}),[P]);return(0,i.useEffect)((()=>{if(h&&m.current){let e={};for(const[t,a]of Object.entries(h)){a.wrapS=a.wrapT=l.RepeatWrapping;const n=(new l.Box3).setFromObject(m.current),o=new l.Vector3,i=n.getSize(o),r=i.x*i.y;a.repeat.set(5e-4*r,5e-4*r),e={...e,[t]:a}}v(e)}}),[h]),p.current&&(p.current.needsUpdate=!0),(0,u.jsx)(u.Fragment,{children:(0,u.jsx)("mesh",{name:t.name,geometry:t.geometry,ref:m,userData:{name:t.userData.name},onPointerDown:e=>{b(!0)},onPointerUp:()=>{x(!1),b(!1)},onPointerMove:e=>{f&&x(!0)},onClick:e=>{var a;if(b(!1),x(!1),g)return;if(null!==O&&void 0!==O&&O.key||null!==D&&void 0!==D&&D.key||null!==N&&void 0!==N&&N.key)return;const n=null===(a=e.intersections.find((e=>e.object.userData.text)))||void 0===a?void 0:a.object.userData.text;if(V&&void 0!==V.index&&n&&n.key)return U(!1),y(V.index),void k(n.key,{edit:!0});E&&void 0!==E.index&&e.intersections[0].object.name===t.name&&(e.stopPropagation(),U(!1),y(E.index))},children:r?(0,u.jsx)("meshStandardMaterial",{ref:p,...o,transparent:!0,bumpScale:.15,side:l.DoubleSide,metalness:-.5}):(0,u.jsx)("meshStandardMaterial",{side:l.DoubleSide,...c,displacementScale:null!==c&&void 0!==c&&c.displacementMap?-.001:void 0,ref:p,color:I})})})},v=e=>{let{node:t,nodeId:a}=e;const o=(0,n.b)((0,i.useCallback)((e=>e.texture(a)),[a])),r=(0,n.b)((0,i.useCallback)((e=>e.optional(a)),[a])),d=!!a.includes("default"),v=(0,s.m)({...o.materials}),p=(0,s.m)({alphaMap:"https://boxxer-api-dev.nyc3.cdn.digitaloceanspaces.com/tassels/tassels-opacity.jpg",bumpMap:"https://boxxer-api-dev.nyc3.cdn.digitaloceanspaces.com/tassels/tassels-bump.jpg",map:o.materials.map},(e=>{const[t,a,n]=e;a.wrapS=a.wrapT=l.RepeatWrapping,a.flipY=!1,a.repeat.set(1.5,1),a.needsUpdate=!0,t.wrapS=t.wrapT=l.RepeatWrapping,t.flipY=!1,t.repeat.set(1.5,1),t.needsUpdate=!0,n.wrapS=t.wrapT=l.RepeatWrapping,n.flipY=!1,n.repeat.set(1.5,1),n.needsUpdate=!0}));return r?null:(0,u.jsx)(c,{node:t,texture:v,tasselsTexture:p,tassels:d,hex:o.hex})},p=e=>{var t,a,n,o,l,d;let{model:s,addNodes:c}=e;const{nodes:p}=(0,r.L)(null===s||void 0===s||null===(t=s.attributes)||void 0===t||null===(a=t.model)||void 0===a||null===(n=a.data)||void 0===n||null===(o=n.attributes)||void 0===o?void 0:o.url);return(0,i.useEffect)((()=>(delete p.Scene,c(p),()=>{c(p,!0)})),[p]),(0,u.jsx)(u.Fragment,{children:null===s||void 0===s||null===(l=s.attributes)||void 0===l||null===(d=l.parts)||void 0===d?void 0:d.data.map((e=>{var t;return(0,u.jsx)(i.Fragment,{children:(null===e||void 0===e||null===(t=e.attributes)||void 0===t?void 0:t.nodeId)&&(0,u.jsx)(v,{node:p[e.attributes.nodeId],nodeId:e.attributes.nodeId},e.attributes.nodeId)},e.id)}))})};var m=a(1435);const f=e=>{var t,a,n,o,r,d,c,v,p,f;let{flag:b,graphic:g,position:x,orientation:h,scale:M=1}=e;const y=null!==b&&void 0!==b&&null!==(t=b.flag)&&void 0!==t&&null!==(a=t.attributes)&&void 0!==a&&null!==(n=a.image.data)&&void 0!==n&&null!==(o=n.attributes)&&void 0!==o&&o.url?[b.flag.attributes.image.data.attributes.url]:null!==g&&void 0!==g&&null!==(r=g.graphic)&&void 0!==r&&null!==(d=r.attributes)&&void 0!==d&&null!==(c=d.image)&&void 0!==c&&null!==(v=c.data)&&void 0!==v&&null!==(p=v.attributes)&&void 0!==p&&p.url?[g.graphic.attributes.image.data.attributes.url]:[],j=null===(f=b||g)||void 0===f?void 0:f.isVisible,w="undefined"===typeof j||j,[P]=(0,s.m)(y),S=(0,i.useMemo)((()=>{var e,t;return(null!==(e=P.source.data.width)&&void 0!==e?e:1)/(null!==(t=P.source.data.height)&&void 0!==t?t:1)}),[P]),T=(0,i.useMemo)((()=>{const e=(new l.Euler).fromArray(h),t=l.MathUtils.radToDeg(e.z),a=(null===b||void 0===b?void 0:b.decalRotation)||(null===g||void 0===g?void 0:g.decalRotation),n=t+(null!==a&&void 0!==a?a:0);return e.z=l.MathUtils.degToRad(n),e}),[null===b||void 0===b?void 0:b.decalRotation,null===g||void 0===g?void 0:g.decalRotation,h]),R=(0,i.useMemo)((()=>new l.Vector3(1*S*M,1*M,4)),[M]);return P?(0,u.jsx)(m._,{position:x,rotation:T,scale:R,children:(0,u.jsx)("meshPhongMaterial",{map:P,transparent:!0,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-20,needsUpdate:!0,opacity:w?1:0})}):null},b=e=>{var t,a,n,o,r,d,s,c,v,p;let{text:f={},position:b,orientation:g,scale:x=1}=e;const h=(0,i.useMemo)((()=>{var e;const t=(new l.Euler).fromArray(g),a=l.MathUtils.radToDeg(t.z)+(null!==(e=null===f||void 0===f?void 0:f.decalRotation)&&void 0!==e?e:0);return t.z=l.MathUtils.degToRad(a),t}),[null===f||void 0===f?void 0:f.decalRotation,g]),M=(null!==f&&void 0!==f&&null!==(t=f.material)&&void 0!==t&&null!==(a=t.attributes)&&void 0!==a&&null!==(n=a.images)&&void 0!==n&&n.length&&null!==(o=f.material.attributes.images[0])&&void 0!==o&&null!==(r=o.image.data)&&void 0!==r&&null!==(d=r.attributes)&&void 0!==d&&d.url&&f.material.attributes.images[0].image.data.attributes.url,"2"===(null===(s=f.selectedName)||void 0===s?void 0:s.id)),y=!!f.puffPrice,j=!!f.crystalPrice,w=j||f.normalMap instanceof l.Texture&&"Luxury"===(null===(c=f.selectedName)||void 0===c||null===(v=c.attributes)||void 0===v?void 0:v.name),P=w?f.normalMap:null;console.log("shouldNormalMap",w);const S="undefined"===typeof f.isVisible||f.isVisible;let T=1;j?T=4:M&&!y?T=.5:M&&y&&(T=3);const R=(0,i.useMemo)((()=>new l.Vector3(3.2*x,.4*x,4)),[x]),k=(0,i.useRef)(null),[U,O]=(0,i.useState)(0);return(0,i.useEffect)((()=>{f.preview&&k.current&&f.preview instanceof l.Texture&&(f.preview.needsUpdate=!0,k.current.needsUpdate=!0)}),[f.preview]),(0,i.useEffect)((()=>{O((e=>e+1))}),[f.normalMap,f.puffPrice,f.crystalPrice,null===(p=f.selectedName)||void 0===p?void 0:p.id]),(0,u.jsx)(m._,{position:b,rotation:h,scale:R,children:(0,u.jsx)("meshStandardMaterial",{ref:k,transparent:!0,roughness:M&&!j?1:0,depthTest:!0,depthWrite:!1,map:f.preview instanceof l.Texture?f.preview:null,normalMap:P,normalScale:new l.Vector2(T,T),opacity:S?1:0})},U)},g=e=>{let{geom:t}=e;const a=(0,n.b)((e=>e.flags)),o=(0,n.b)((e=>e.texts)),i=(0,n.b)((e=>e.graphics));return(0,u.jsxs)("mesh",{geometry:t,renderOrder:1,children:[(0,u.jsx)("meshStandardMaterial",{transparent:!0,colorWrite:!1}),a.map((e=>{if(e.decalPosition&&e.decalOrientation)return(0,u.jsx)(f,{flag:e,position:e.decalPosition,orientation:e.decalOrientation,scale:e.decalScale},e.key)})),i.map((e=>{if(e.decalPosition&&e.decalOrientation)return(0,u.jsx)(f,{graphic:e,position:e.decalPosition,orientation:e.decalOrientation,scale:e.decalScale},e.key)})),o.map((e=>{if(e.decalPosition&&e.decalOrientation)return(0,u.jsx)(b,{text:e,position:e.decalPosition,orientation:e.decalOrientation,scale:e.decalScale},e.key)}))]})};var x=a(7133);const h=e=>{let{children:t}=e;const[a,o]=(0,i.useState)(),{customProduct:l}=(0,n.b)();return t({addNodes:function(e,t){if(t){const t={...a};for(const a in e)delete t[a];o({...t})}else o((t=>({...t,...e})))},geom:(0,i.useMemo)((()=>{const e=[];if(a)for(const[o,i]of Object.entries(a)){var t,n;const a=(null!==(t=null===l||void 0===l||null===(n=l.attributes)||void 0===n?void 0:n.parts)&&void 0!==t?t:[]).filter((e=>null===e||void 0===e?void 0:e.optional)).map((e=>{var t;return null===e||void 0===e||null===(t=e.modelParts)||void 0===t?void 0:t.data})).flat().find((e=>{var t;return(null===e||void 0===e||null===(t=e.attributes)||void 0===t?void 0:t.nodeId)===o}));i.isMesh&&!a&&e.push(i.geometry.clone())}return e.length?x.qf(e):null}),[a])})},M=e=>e.selectedModels,y=(0,i.forwardRef)(((e,t)=>{let{onPointerDown:a,onPointerUp:r,onPointerMove:d,onClick:s}=e;const c=(0,n.b)(M),{remountTrigger:v}=(0,n.b)(),m=(0,o.H)((e=>e.modelRotation)),f=(0,o.H)((e=>e.addingToCart));return(0,i.useEffect)((()=>{f&&"function"!==typeof t&&null!==t&&void 0!==t&&t.current&&t.current.rotateY(l.MathUtils.degToRad(m))}),[f,m]),(0,u.jsx)("group",{name:"meshGroup",ref:t,onPointerDown:a,onPointerUp:r,onPointerMove:d,onClick:s,dispose:null,children:(0,u.jsx)(h,{children:e=>{let{addNodes:t,geom:a}=e;return(0,u.jsxs)(u.Fragment,{children:[c.map((e=>{var a;return(0,u.jsx)(p,{model:e.model,addNodes:t},null===(a=e.model)||void 0===a?void 0:a.id)})),a&&(0,u.jsx)(g,{geom:a})]})}},v)})}));y.displayName="Scene";const j=y}}]);
//# sourceMappingURL=369.0b688528.chunk.js.map